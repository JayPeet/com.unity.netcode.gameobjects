{% metadata_file .yamato/project.metafile %}
---

{% for project in projects.default -%}
{% for editor in validation_editors.all -%}
{% for platform in test_platforms.default -%}
webgl_build_{{ project.name }}_{{ editor }}:
  name: WebGl Build - [{{ project.name }}, {{ editor }}]
  agent:
    type: {{ platform.type }}
    image: {{ platform.image }}
    flavor: {{ platform.flavor }}
  commands:
    - pip install unity-downloader-cli --index-url https://artifactory.prd.it.unity3d.com/artifactory/api/pypi/pypi/simple
    # Download appropriate UTR based on platform
{% if platform.name == "win" %}
    - curl -s https://artifactory.prd.it.unity3d.com/artifactory/unity-tools-local/utr-standalone/utr.bat --output utr.bat
{% else %}
    - curl -s https://artifactory.prd.it.unity3d.com/artifactory/unity-tools-local/utr-standalone/utr --output utr
    - chmod +x utr
{% endif %}
    - python .yamato/disable-burst-if-requested.py --project-path {{ project.path }} --platform WebGL
    - unity-downloader-cli -u {{ editor }} -c editor -c webgl -c il2cpp -w --fast
    - set UTR_VERSION=1.35.1
{% if platform.name == "win" %}
    - utr.bat 
{% else %} 
    - ./utr {% endif %} --artifacts_path=artifacts --timeout=1800 --testproject={{ project.name }} --editor-location=.Editor --suite=playmode --platform=WebGL --build-only --player-save-path=build/players --extra-editor-arg=-batchmode --extra-editor-arg=-nographics --scripting-backend=il2cpp --extra-editor-arg="-cloudEnvironment staging"
  artifacts:
    logs:
      paths:
        - '*.log'
        - '*.xml'
        - artifacts/**/*
        - testproject/Logs/**
        - testproject/Library/*.log
        - testproject/*.log
        - testproject/Builds/*.log
        - build/test-results/**
        - artifacts/**
        - build/players/**
  variables:
    CI: true
    ENABLE_BURST_COMPILATION: False
{% endfor -%}
{% endfor -%}
{% endfor -%}
